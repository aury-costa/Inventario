<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InventÃ¡rio de Estoque</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <script type="module" src="firebase.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo">ðŸ“¦</div>
        <div>
          <div class="title">InventÃ¡rio de Estoque</div>
          <div class="subtitle">Compare o estoque do sistema com a contagem fÃ­sica</div>
        </div>
      </div>

      
      <div class="meta-form" aria-label="InformaÃ§Ãµes do inventÃ¡rio">
        <div class="meta-field">
          <label for="metaUnidade">Loja/Unidade</label>
          <input id="metaUnidade" type="text" placeholder="Ex.: Loja 01" />
        </div>
        <div class="meta-field">
          <label for="metaResponsavel">ResponsÃ¡vel</label>
          <input id="metaResponsavel" type="text" placeholder="Ex.: Patrick" />
        </div>
      </div>

      <div class="top-actions">
        <button id="btnPdf" class="btn btn-secondary" title="Gerar relatÃ³rio em PDF">RelatÃ³rio PDF</button>
        <button id="btnExport" class="btn btn-secondary" title="Exportar contagens">Exportar</button>
        <button id="btnReset" class="btn btn-danger" title="Zerar contagens">Zerar</button>
      </div>
    </header>

    <main class="main">
      <section class="panel panel-left">
        <div class="panel-header">
          <div class="panel-title">Base de produtos</div>
          <div class="panel-actions">
            <label class="file-pill" for="csvFile">
              <input id="csvFile" type="file" accept=".csv,text/csv" />
              <span>Carregar CSV</span>
            </label>
          </div>
        </div>

        <div class="search">
          <div class="search-row">
            <input id="searchInput" type="search" placeholder="Buscar por descriÃ§Ã£o, CÃ³digo Produto ou CÃ³digo Acesso (EAN/balanÃ§a)..." />
            <button id="btnScan" class="btn btn-secondary scan-btn" title="Ler cÃ³digo de barras (cÃ¢mera)">ðŸ“· Ler</button>
            <label class="collector-toggle" title="Modo contagem rÃ¡pida (coletor)"><input id="toggleCollector" type="checkbox" /> <span>Modo Coletor</span></label>
          </div>
          <div class="search-hint">Dica: vocÃª pode digitar parte do nome do produto, ou o cÃ³digo do sistema/EAN.</div>
        </div>

        <div class="list-meta">
          <div class="chip" id="chipTotal">Total: â€”</div>
          <div class="chip" id="chipCounted">Contados: â€”</div>
          <div class="chip" id="chipMissing">Faltando: â€”</div>
        </div>

        <div class="table-wrap">
          <table class="table" id="productsTable" aria-label="Lista de produtos">
            <thead>
              <tr>
                <th style="width: 110px;">CÃ³digo</th>
                <th>Produto</th>
                <th style="width: 90px;" class="num">Sistema</th>
                <th style="width: 90px;" class="num">Contado</th>
                <th style="width: 100px;" class="num">Dif.</th>
              </tr>
            </thead>
            <tbody id="productsTbody">
              <tr><td colspan="5" class="muted">Carregandoâ€¦</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel panel-right">
        <div class="tabs">
          <button class="tab active" data-tab="contagem">Contagem</button>
          <button class="tab" data-tab="progresso">Progresso</button>
          <button class="tab" data-tab="divergencia">DivergÃªncia</button>
          <button class="tab" data-tab="dashboard">Dashboard</button>
        </div>

        <div class="tabpanels">
          <div class="tabpanel active" id="tab-contagem">
            <div class="detail">
              <div class="detail-head">
                <div>
                  <div class="detail-title" id="detailTitle">Selecione um produto</div>
                  <div class="detail-sub" id="detailSub">Use a busca para localizar rapidamente.</div>
                </div>
                <span class="badge" id="detailBadge">â€”</span>
              </div>

              <div class="detail-grid">
                <div class="card">
                  <div class="card-label">CÃ³digo Produto (sistema)</div>
                  <div class="card-value mono" id="detailCodigo">â€”</div>
                </div>
                <div class="card">
                  <div class="card-label">CÃ³digo Acesso (EAN/balanÃ§a)</div>
                  <div class="card-value mono" id="detailAcesso">â€”</div>
                </div>
                <div class="card">
                  <div class="card-label">Qtd. em Estoque (sistema)</div>
                  <div class="card-value" id="detailSistema">â€”</div>
                </div>
                <div class="card">
                  <div class="card-label">Dias Ãšlt. Entrada</div>
                  <div class="card-value" id="detailDias">â€”</div>
                </div>
                <div class="card">
                  <div class="card-label">Custo Liq. UnitÃ¡rio</div>
                  <div class="card-value" id="detailCusto">â€”</div>
                </div>
                <div class="card">
                  <div class="card-label">Impacto (R$)</div>
                  <div class="card-value" id="detailImpacto">â€”</div>
                </div>
              </div>

              <div class="count-box">
                <div class="count-row">
                  <label for="countInput">Quantidade contada (fÃ­sico)</label>
                  <input id="countInput" inputmode="decimal" placeholder="Ex.: 8" />
                </div>
                <div class="count-actions">
                  <button id="btnSave" class="btn btn-primary">Salvar contagem</button>
                  <button id="btnClearOne" class="btn btn-secondary">Limpar deste item</button>
                </div>
                <div class="mini-help" id="saveHint">As contagens ficam salvas neste dispositivo (localStorage).</div>
              </div>
            </div>
          </div>

          <div class="tabpanel" id="tab-progresso">
            <div class="kpis">
              <div class="kpi">
                <div class="kpi-label">Total itens</div>
                <div class="kpi-value" id="kpiTotal">â€”</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Contados</div>
                <div class="kpi-value" id="kpiCounted">â€”</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">OK (sem divergÃªncia)</div>
                <div class="kpi-value" id="kpiOk">â€”</div>
              </div>
              <div class="kpi">
                <div class="kpi-label">Com divergÃªncia</div>
                <div class="kpi-value" id="kpiDiv">â€”</div>
              </div>
            </div>

            <div class="charts">
              <div class="chart-card">
                <div class="chart-title">Status da contagem</div>
                <canvas id="chartStatus" height="220"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-title">Resumo financeiro</div>
                <div class="money-grid">
                  <div class="money">
                    <div class="money-label">Impacto lÃ­quido (R$)</div>
                    <div class="money-value" id="moneyNet">â€”</div>
                  </div>
                  <div class="money">
                    <div class="money-label">Impacto absoluto (R$)</div>
                    <div class="money-value" id="moneyAbs">â€”</div>
                  </div>
                </div>
                <div class="money-note">Impacto = (Contado âˆ’ Sistema) Ã— Custo Liq. UnitÃ¡rio.</div>
              </div>
            </div>


            <div class="filters">
              <div class="filter-label">Filtro:</div>
              <select id="progressFilter" class="select">
                <option value="all">Todos</option>
                <option value="ok">OK</option>
                <option value="div">DivergÃªncia (geral)</option>
                <option value="over">Sobra (FÃ­sico &gt; Sistema)</option>
                <option value="under">Falta (Sistema &gt; FÃ­sico)</option>
                <option value="missing">Faltando contar</option>
              </select>
            </div>

            <div class="table-wrap">
              <table class="table" aria-label="Resumo do inventÃ¡rio">
                <thead>
                  <tr>
                    <th style="width: 110px;">CÃ³digo</th>
                    <th>Produto</th>
                    <th style="width: 90px;" class="num">Sistema</th>
                    <th style="width: 90px;" class="num">Contado</th>
                    <th style="width: 90px;" class="num">Dif.</th>
                    <th style="width: 110px;" class="num">Impacto (R$)</th>
                    <th style="width: 120px;">Status</th>
                  </tr>
                </thead>
                <tbody id="progressTbody">
                  <tr><td colspan="7" class="muted">Sem dados.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="tabpanel" id="tab-divergencia">

            <div class="filters">
              <div class="filter-label">Filtro:</div>
              <div class="seg" role="group" aria-label="Filtro de divergÃªncia">
                <button class="seg-btn active" data-divfilter="all">Todos</button>
                <button class="seg-btn" data-divfilter="div">DivergÃªncia</button>
                <button class="seg-btn" data-divfilter="over">Sobra</button>
                <button class="seg-btn" data-divfilter="under">Falta</button>
                <button class="seg-btn" data-divfilter="ok">OK</button>
              </div>
            </div>

            <div class="charts">
              <div class="chart-card">
                <div class="chart-title">Top divergÃªncias (valor absoluto)</div>
                <canvas id="chartTopDiv" height="260"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-title">DivergÃªncias (lista)</div>
                <div class="table-wrap tight">
                  <table class="table" aria-label="DivergÃªncias">
                    <thead>
                      <tr>
                        <th style="width: 110px;">CÃ³digo</th>
                        <th>Produto</th>
                        <th style="width: 90px;" class="num">Dif.</th>
                        <th style="width: 120px;" class="num">Impacto (R$)</th>
                      </tr>
                    </thead>
                    <tbody id="divTbody">
                      <tr><td colspan="4" class="muted">Sem divergÃªncias.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="note">
              <div class="note-title">Como usar</div>
              <ul>
                <li>Procure um item, selecione e informe a quantidade fÃ­sica.</li>
                <li>O app calcula a diferenÃ§a (Contado âˆ’ Sistema) e o impacto pelo custo.</li>
                <li>Use <b>Exportar</b> para gerar um CSV das contagens, diferenÃ§as e impacto.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="muted">Funciona offline (apÃ³s abrir uma vez). Para uso em rede, basta hospedar esta pasta em qualquer servidor.</div>
    </footer>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>


        <div class="tabpanel" id="tab-dashboard">
          <div class="panel">
            <div class="panel-title">Dashboard gerencial</div>
            <div class="kpis">
              <div class="kpi"><div class="kpi-label">AcurÃ¡cia (itens)</div><div class="kpi-value" id="kpiAccuracy">â€”</div></div>
              <div class="kpi"><div class="kpi-label">Quebra lÃ­quida (R$)</div><div class="kpi-value" id="kpiNetBreak">â€”</div></div>
              <div class="kpi"><div class="kpi-label">Quebra absoluta (R$)</div><div class="kpi-value" id="kpiAbsBreak">â€”</div></div>
              <div class="kpi"><div class="kpi-label">Produtividade</div><div class="kpi-value" id="kpiProd">â€”</div></div>
            </div>

            <div class="charts">
              <div class="chart-card">
                <div class="chart-title">Impacto por tipo</div>
                <canvas id="breakTypeChart"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-title">Top 20 impactos (R$)</div>
                <canvas id="topImpactChart"></canvas>
              </div>
            </div>

            <div class="panel-subtitle">Contagem por usuÃ¡rio</div>
            <div class="table-wrap">
              <table class="table" aria-label="Contagem por usuÃ¡rio">
                <thead>
                  <tr>
                    <th>UsuÃ¡rio</th>
                    <th class="num">Itens contados</th>
                    <th class="num">DivergÃªncias</th>
                    <th class="num">Impacto abs (R$)</th>
                  </tr>
                </thead>
                <tbody id="userStatsBody"></tbody>
              </table>
            </div>
          </div>
        </div>


  <!-- Modal Leitor de CÃ³digo -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Leitor de cÃ³digo">
      <div class="modal-head">
        <div>
          <div class="modal-title">Ler cÃ³digo (EAN/balanÃ§a)</div>
          <div class="modal-sub">Aponte a cÃ¢mera para o cÃ³digo. Ao detectar, a busca serÃ¡ preenchida automaticamente.</div>
        </div>
        <button class="btn btn-danger" id="btnCloseScan" title="Fechar">Fechar</button>
      </div>
      <div class="modal-body">
        <video id="scanVideo" playsinline></video>
        <div class="scan-hint" id="scanHint">Iniciando cÃ¢meraâ€¦</div>
      </div>
    </div>
  </div>


  <!-- Login simples (usuÃ¡rio) -->
  <div class="overlay" id="loginOverlay" aria-hidden="false">
    <div class="overlay-card" role="dialog" aria-modal="true" aria-label="Login">
      <div class="overlay-title">Entrar no InventÃ¡rio</div>
      <div class="overlay-sub">Digite seu usuÃ¡rio (ex.: <b>au.costa</b>). Sem senha por enquanto.</div>
      <div class="overlay-row">
        <input id="loginUser" type="text" placeholder="UsuÃ¡rio" autocomplete="username" />
        <button class="btn btn-primary" id="btnLogin">Entrar</button>
      </div>
      <div class="overlay-hint">Este usuÃ¡rio serÃ¡ registrado nas contagens e no relatÃ³rio.</div>
    </div>
  </div>

</body>
</html>
